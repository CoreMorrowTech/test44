<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoreMorrow Nano Motion Control Software</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }

        body {
            width: 100vw;
            height: 100vh;
            position: relative;
            overflow: hidden;
            /* background-image: url('1.jpg'); */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .title {
            position: absolute;
            left: 37.5%;
            top: 4.9%;
            width: 26.04%;
            height: 4.63%;
            color: #000000;
            font-size: 2.16vw;
            font-weight: bold;
            text-align: center;
            line-height: 4.63vh;
        }

        .subtitle {
            position: absolute;
            left: 28.57%;
            top: 9.35%;
            width: 41.67%;
            height: 2.78%;
            color: #000000;
            font-size: 1.19vw;
            font-weight: bold;
            text-align: center;
            line-height: 2.78vh;
        }

        .frame {
            position: absolute;
            left: 13.8%;
            top: 20.74%;
            width: 83.8%;
            height: 17.41%;
            border: 1px solid #000;
            background-color: transparent;
            display: flex;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: center;
            gap: 0.73%;
            padding: 0.42%;
            overflow-x: auto;
        }

        .frame2 {
            position: absolute;
            margin: 2.71% 0 0 2.71%;
            top: 42.9%;
            width: 79.74%;
            height: 48.33%;
            border: 1px solid #000;
            background-color: transparent;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .search-box {
            position: absolute;
            left: 3.125%;
            top: 31.63%;
            width: 8.02%;
            height: 3.54%;
            padding: 0.26%;
            font-size: 0.73vw;
        }

        .search-btn {
            position: absolute;
            left: 10.3%;
            top: 31.63%;
            width: 3.54%;
            height: 3.54%;
            background-image: url('search.png');
            background-color: #c80025;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            border: 0px solid #000;

        }

        .device {
            display: inline-block;
            margin: 0.82%;
            width: 9.11%;
        }

        .device-img {

            width: 115%;
            height: 10.47vh;
            background-color: #4629c7;
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
        }

        .device-label-container {
            display: flex;
            width: 115%;
            justify-content: space-between;
            align-items: center;
        }

        .device-label {
            width: 81.14%;
            height: 2.87vh;
            background-color: #d3d3d3;
            text-align: center;
            line-height: 2.87vh;
            font-size: 0.73vw;
        }

        .device-btn {
            width: 18.86%;
            height: 2.87vh;
            background-image: url('4.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #d3d3d3;
            border: 0px solid #000;
            cursor: pointer;
        }

        .remove-btn {
            width: 18.86%;
            height: 2.87vh;
            background-image: url('-.png');
            background-size: contain;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #efefef;
            border: 0px solid #000;
            cursor: pointer;
        }

        .close-btn {
            position: absolute;
            color: white;
            font-weight: bold;
            right: 2.7%;
            top: 6.85%;
            width: 8.53%;
            height: 5.19vh;
            background-color: #3e3e3e;
            font-size: 1.54vw;
            text-align: center;
            line-height: 5.19vh;
            cursor: pointer;
            border-radius: 1.92vh;
        }

        .menu-bar {
            position: absolute;
            top: 12.85%;
            left: 2.85%;
            width: 43.52%;
            height: 5.56vh;
            background-color: #3e3e3e;
            display: flex;
            align-items: center;
            padding-left: 1%;
        }

        .menu-item {
            color: #fff;
            font-size: 1vw;
            margin-right: 4%;
            cursor: pointer;
            padding: 3% 8%;
        }

        .menu-item:hover {
            background-color: #c80025;
        }

        /* 下拉菜单样式 */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;

            position: absolute;
            background-color: #3e3e3e;
            min-width: 140%;
            left: 0;
            top: 100%;
            z-index: 1;
        }

        .dropdown-content div {
            color: white;
            padding: 5% 5%;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }

        .dropdown-content div:hover {
            background-color: #c80025;
        }
    </style>
</head>

<body>
    <div class="menu-bar">
        <div class="menu-item dropdown">
            File
            <div class="dropdown-content">
                <div>Import Device</div>
                <div>New/Edit Device</div>
                <div>Export Page Records</div>
                <div>Close File</div>
                <div>Exit Current Window</div>
            </div>
        </div>
        <div class="menu-item dropdown">
            Info
            <div class="dropdown-content">
                <div>Factory Report Query</div>
            </div>
        </div>
        <div class="menu-item dropdown">
            Settings
            <div class="dropdown-content">
                <div>Calibration Parameter Settings</div>
                <div>Debug Parameter Settings</div>
                <div>Controller Firmware Upgrade</div>
                <div>System Language/Language</div>
            </div>
        </div>
        <div class="menu-item dropdown">
            Help
            <div class="dropdown-content">
                <div>User Manual</div>
                <div>Help Videos</div>
                <div>Check for Updates</div>
                <div>Update Content</div>
                <div>About</div>
            </div>
        </div>
    </div>


    <h1 class="title">CoreMorrow Nano Motion Control Software</h1>
    <h2 class="subtitle">COREMORROW NANO MOTION CONTROL SOFTWARE</h2>

    <div class="frame">
        <div class="device">
            <div class="device-img" style="background-image: url('3.png')"></div>
            <div class="device-label-container">
                <div class="device-label">Device Model 1</div>
                <div class="device-btn" onclick="addDevice('Device Model 1')"></div>
            </div>
        </div>

        <div class="device">
            <div class="device-img" style="background-image: url('E53.D3E-J缩略图.jpg')"></div>
            <div class="device-label-container">
                <div class="device-label">Device Model 2</div>
                <div class="device-btn" onclick="addDevice('Device Model 2')"></div>
            </div>
        </div>


    </div>

    <div class="frame2" id="frame2"></div>

    <input type="text" class="search-box" placeholder="Enter product model" id="searchInput">
    <button class="search-btn" onclick="searchDevice()"></button>
    <div class="close-btn" onclick="window.close()">Exit</div>

    <script>
        // 引入core-koffi.js模块
        const { COM, UDP } = require('./core-koffi.js');

        // 全局变量存储连接实例
        let connectionInstances = new Map();

        // 显示/隐藏下拉菜单
        document.querySelectorAll('.dropdown').forEach(dropdown => {
            dropdown.addEventListener('mouseenter', function () {
                this.querySelector('.dropdown-content').style.display = 'block';
            });
            dropdown.addEventListener('mouseleave', function () {
                this.querySelector('.dropdown-content').style.display = 'none';
            });
        });
        function searchDevice() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const devices = document.querySelectorAll('.device');

            devices.forEach(device => {
                const label = device.querySelector('.device-label');
                const shouldShow = label.textContent.toLowerCase().includes(searchText);
                device.style.display = shouldShow ? 'inline-block' : 'none';
            });
        }

        // Device model to image mapping
        const deviceImageMap = {
            'Device Model 1': '1.png',
            'Device Model 2': 'E53.D3E-J缩略图.jpg',
            'Device Model 3': '3.png',
            'Device Model 4': '4.png'
        };

        function addDevice(deviceModel) {
            const frame2 = document.getElementById('frame2');
            const deviceId = 'device-' + Date.now();

            const deviceElement = document.createElement('div');
            deviceElement.className = 'frame2-device';
            deviceElement.id = deviceId;
            deviceElement.style.width = '100%';
            deviceElement.style.minHeight = '50%';
            deviceElement.style.backgroundColor = '#ff9f9';
            deviceElement.style.display = 'flex';
            deviceElement.style.alignItems = 'center';
            deviceElement.style.padding = '10px';

            // 图片容器
            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            imgContainer.style.width = '20%';
            imgContainer.style.height = '100%';
            imgContainer.style.marginRight = '10px';

            const deviceImg = document.createElement('div');
            deviceImg.className = 'device-img';
            deviceImg.style.backgroundImage = `url('${deviceImageMap[deviceModel] || '3.png'}')`;
            deviceImg.style.width = '100%';
            deviceImg.style.height = '100%';
            deviceImg.style.backgroundSize = 'contain';
            deviceImg.style.backgroundPosition = 'center';
            deviceImg.style.backgroundRepeat = 'no-repeat';
            imgContainer.appendChild(deviceImg);

            // 删除按钮
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-btn';
            removeBtn.style.position = 'absolute';
            removeBtn.style.right = '0%';
            removeBtn.style.top = '4%';
            removeBtn.style.backgroundImage = "url('-.png')";
            removeBtn.onclick = function () {
                frame2.removeChild(deviceElement);
            };
            imgContainer.appendChild(removeBtn);

            // Add device model label
            const modelLabel = document.createElement('div');
            modelLabel.textContent = 'Product Model: ' + deviceModel;
            modelLabel.style.marginTop = '3%';
            modelLabel.style.textAlign = 'left';
            modelLabel.style.fontSize = '0.8vw';
            modelLabel.style.backgroundColor = '#d3d3d3';
            imgContainer.appendChild(modelLabel);

            // Add product number label (editable)
            const productNumberLabel = document.createElement('div');
            productNumberLabel.textContent = 'Product Number: ';
            productNumberLabel.style.marginTop = '0%';
            productNumberLabel.style.textAlign = 'left';
            productNumberLabel.style.fontSize = '0.8vw';
            productNumberLabel.style.backgroundColor = '#d3d3d3';

            const productNumberInput = document.createElement('input');
            productNumberInput.type = 'text';
            productNumberInput.value = '2024010978';
            productNumberInput.style.width = '50%';
            productNumberInput.style.textAlign = 'left';
            productNumberInput.style.border = '1px solid #d3d3d3';
            productNumberInput.style.fontSize = '0.8vw';
            productNumberInput.style.backgroundColor = '#d3d3d3';

            productNumberLabel.appendChild(productNumberInput);
            imgContainer.appendChild(productNumberLabel);

            // Add device address label and modify button
            const addressContainer = document.createElement('div');
            addressContainer.style.display = 'flex';
            addressContainer.style.justifyContent = 'space-between';
            addressContainer.style.alignItems = 'center';
            addressContainer.style.marginTop = '0%';
            addressContainer.style.backgroundColor = '#ffffff';
            addressContainer.style.padding = '2px';



            const editAddressBtn = document.createElement('button');
            editAddressBtn.textContent = 'Modify Address';
            editAddressBtn.style.fontSize = '0.6vw';
            editAddressBtn.style.marginTop = '6%';

            editAddressBtn.style.width = '52%';
            editAddressBtn.style.height = '2.5vh';
            // editAddressBtn.style.padding = '1px 5px';
            editAddressBtn.style.backgroundColor = '#c80025';
            editAddressBtn.style.color = 'white';
            editAddressBtn.style.border = 'none';
            editAddressBtn.style.borderRadius = '3px';
            editAddressBtn.style.cursor = 'pointer';

            // Add address label (editable)
            const addressLabel = document.createElement('div');
            addressLabel.textContent = 'Device Address: ';
            addressLabel.style.fontSize = '0.8vw';
            addressLabel.style.marginTop = '6%';
            addressLabel.style.textAlign = 'left';
            addressLabel.style.backgroundColor = '#ffffff';

            const addressInput = document.createElement('input');
            addressInput.type = 'text';
            addressInput.value = '8';
            addressInput.style.width = '50%';
            productNumberInput.style.textAlign = 'left';
            addressInput.style.border = '0px solid #d3d3d3';
            addressInput.style.fontSize = '0.8vw';
            addressInput.style.backgroundColor = '#ffffff';

            addressLabel.appendChild(addressInput);
            addressContainer.appendChild(addressLabel);
            addressContainer.appendChild(editAddressBtn);
            imgContainer.appendChild(addressContainer);

            // Control container
            const controlContainer = document.createElement('div');
            controlContainer.style.flexGrow = '1';
            controlContainer.style.display = 'flex';
            controlContainer.style.flexDirection = 'column';
            // controlContainer.style.gap = '10px';

            const modes = [
                {
                    label: 'RS-232',
                    inputs: ['COM1', '115200dps', '8 data bits', '1 stop bit', 'No parity']
                },
                {
                    label: 'RS-422',
                    inputs: ['COM2', '115200dps', '8 data bits', '1 stop bit', 'No parity']
                },
                {
                    label: 'USB-VCP',
                    inputs: ['COM3', '115200dps', '8 data bits', '1 stop bit', 'No parity']
                },
                {
                    label: 'LAN-UDP',
                    inputs: ['UDP, Local IP: 192.168.0.100:7010', 'UDP, Target IP: 192.168.0.101:7010']
                }
            ];

            modes.forEach(mode => {
                const modeContainer = document.createElement('div');
                modeContainer.style.display = 'flex';
                modeContainer.style.alignItems = 'center';
                // modeContainer.style.gap = '10px';

                const modeLabel = document.createElement('div');
                modeLabel.textContent = mode.label;
                modeLabel.style.flexBasis = '10%';
                modeLabel.style.fontSize = '0.8vw';
                modeLabel.style.textAlign = 'center';
                modeLabel.style.backgroundColor = '#c80025';
                modeLabel.style.width = '10%';
                modeLabel.style.color = 'white';
                // modeLabel.style.padding = '5px';
                // modeLabel.style.borderRadius = '5px';
                modeContainer.appendChild(modeLabel);

                const inputField = document.createElement('input');
                inputField.type = 'text';
                inputField.value = mode.inputs.join(' '); // Combine into one input field
                inputField.style.width = '80%'; // Set width to 300px
                inputField.style.padding = '5px';
                inputField.style.fontSize = '0.7em';
                inputField.style.border = '1px solid #ccc';
                modeContainer.appendChild(inputField);

                ['Modify', 'Connect', 'Disconnect'].forEach(action => {
                    const actionButton = document.createElement('button');
                    actionButton.textContent = action;
                    actionButton.style.flexBasis = '10%';
                    actionButton.style.fontSize = '5px';
                    actionButton.style.padding = '5px';
                    actionButton.style.backgroundColor = action === 'Disconnect' ? '#ccc' : '#c80025';
                    actionButton.style.color = 'white';
                    actionButton.style.border = 'none';
                    actionButton.style.cursor = 'pointer';

                    // 添加点击事件处理
                    if (action === 'Connect') {
                        actionButton.onclick = () => connectDevice(deviceId, mode.label, inputField.value, actionButton);
                    } else if (action === 'Disconnect') {
                        actionButton.onclick = () => disconnectDevice(deviceId, mode.label, actionButton);
                    } else if (action === 'Modify') {
                        actionButton.onclick = () => modifyConnection(inputField);
                    }

                    modeContainer.appendChild(actionButton);
                });

                controlContainer.appendChild(modeContainer);
            });

            deviceElement.appendChild(imgContainer);
            deviceElement.appendChild(controlContainer);
            frame2.appendChild(deviceElement);
        }

        // Global variable to store current language state
        let currentLanguage = 'en'; // Default language is English

        // Language toggle function
        function toggleLanguage() {
            const isEnglish = currentLanguage === 'en';
            currentLanguage = isEnglish ? 'zh' : 'en';

            // Update page text content
            document.querySelector('.title').textContent = isEnglish ? '芯明天纳米运动控制软件' : 'CoreMorrow Nano Motion Control Software';
            document.querySelector('.subtitle').textContent = isEnglish ? '芯明天纳米运动控制软件' : 'COREMORROW NANO MOTION CONTROL SOFTWARE';

            // Update menu bar content
            const menuItems = document.querySelectorAll('.menu-item.dropdown');
            const menuTexts = isEnglish
                ? ['文件', '信息', '设置', '帮助']
                : ['File', 'Info', 'Settings', 'Help'];

            menuItems.forEach((item, index) => {
                item.childNodes[0].textContent = menuTexts[index];
            });

            // Update dropdown menu content
            const dropdownContents = document.querySelectorAll('.dropdown-content');
            const dropdownTexts = isEnglish
                ? [
                    ['导入设备', '新建/编辑设备', '导出页面记录', '文件关闭', '当前窗口退出'],
                    ['出厂报告查询'],
                    ['标定参数设置', '调试参数设置', '控制器固件升级', '系统语言/Language'],
                    ['用户手册', '帮助视频', '检查更新', '更新内容', '关于', '修改']
                ]
                : [
                    ['Import Device', 'New/Edit Device', 'Export Page Records', 'Close File', 'Exit Current Window'],
                    ['Factory Report Query'],
                    ['Calibration Parameter Settings', 'Debug Parameter Settings', 'Controller Firmware Upgrade', 'System Language/Language'],
                    ['User Manual', 'Help Videos', 'Check for Updates', 'Update Content', 'About', 'Modify']
                ];

            dropdownContents.forEach((content, index) => {
                const items = content.querySelectorAll('div');
                items.forEach((item, subIndex) => {
                    item.textContent = dropdownTexts[index][subIndex];
                });
            });
        }

        // 为“系统语言/Language”菜单项添加点击事件
        document.querySelectorAll('.dropdown-content div').forEach(item => {
            if (item.textContent.includes('System Language') || item.textContent.includes('Language')) {
                item.onclick = toggleLanguage;
            }
        });

        /**
         * 连接设备函数
         * @param {string} deviceId - 设备ID
         * @param {string} connectionType - 连接类型 (RS-232, RS-422, USB-VCP, LAN-UDP)
         * @param {string} connectionInfo - 连接信息字符串
         * @param {HTMLElement} button - 连接按钮元素
         */
        function connectDevice(deviceId, connectionType, connectionInfo, button) {
            try {
                const connectionKey = `${deviceId}-${connectionType}`;

                // 如果已经连接，先断开
                if (connectionInstances.has(connectionKey)) {
                    disconnectDevice(deviceId, connectionType, button);
                }

                let connection = null;

                if (connectionType === 'LAN-UDP') {
                    // 解析UDP连接信息
                    const udpInfo = parseUDPInfo(connectionInfo);
                    if (!udpInfo) {
                        throw new Error('UDP连接信息格式错误');
                    }

                    connection = new UDP(
                        udpInfo.targetIP,
                        udpInfo.targetPort,
                        udpInfo.localIP,
                        udpInfo.localPort
                    );

                    console.log(`✓ UDP连接成功: ${udpInfo.localIP}:${udpInfo.localPort} -> ${udpInfo.targetIP}:${udpInfo.targetPort}`);

                } else {
                    // 串口连接 (RS-232, RS-422, USB-VCP)
                    const comInfo = parseCOMInfo(connectionInfo);
                    if (!comInfo) {
                        throw new Error('串口连接信息格式错误');
                    }

                    connection = new COM(
                        comInfo.port,
                        comInfo.baudrate,
                        comInfo.dataBits,
                        comInfo.stopBits,
                        comInfo.parity
                    );

                    console.log(`✓ 串口连接成功: ${comInfo.port}, ${comInfo.baudrate}bps`);
                }

                // 存储连接实例
                connectionInstances.set(connectionKey, connection);

                // 更新按钮状态
                button.style.backgroundColor = '#28a745'; // 绿色表示已连接
                button.textContent = 'Connected';

                // 更新同行的断开按钮状态
                const disconnectBtn = button.parentElement.querySelector('button:last-child');
                if (disconnectBtn) {
                    disconnectBtn.style.backgroundColor = '#c80025';
                    disconnectBtn.style.cursor = 'pointer';
                }

                console.log(`设备 ${deviceId} 通过 ${connectionType} 连接成功`);

            } catch (error) {
                console.error(`连接失败: ${error.message}`);
                // 不使用弹窗，直接在控制台显示错误
                console.log(`连接失败: ${error.message}`);
            }
        }

        /**
         * 断开设备连接函数
         * @param {string} deviceId - 设备ID
         * @param {string} connectionType - 连接类型
         * @param {HTMLElement} button - 断开按钮元素
         */
        function disconnectDevice(deviceId, connectionType, button) {
            try {
                const connectionKey = `${deviceId}-${connectionType}`;
                const connection = connectionInstances.get(connectionKey);

                if (connection) {
                    // 关闭连接
                    connection.close();
                    connectionInstances.delete(connectionKey);

                    console.log(`设备 ${deviceId} 的 ${connectionType} 连接已断开`);
                }

                // 更新按钮状态
                button.style.backgroundColor = '#ccc';
                button.style.cursor = 'default';

                // 更新同行的连接按钮状态
                const connectBtn = button.parentElement.querySelector('button:nth-child(3)');
                if (connectBtn) {
                    connectBtn.style.backgroundColor = '#c80025';
                    connectBtn.textContent = 'Connect';
                }

            } catch (error) {
                console.error(`断开连接失败: ${error.message}`);
            }
        }

        /**
         * 修改连接信息函数
         * @param {HTMLElement} inputField - 输入框元素
         */
        function modifyConnection(inputField) {
            // 使输入框可编辑
            inputField.focus();
            inputField.select();
        }

        /**
         * 解析串口连接信息
         * @param {string} connectionInfo - 连接信息字符串
         * @returns {Object|null} 解析后的连接参数
         */
        function parseCOMInfo(connectionInfo) {
            try {
                const parts = connectionInfo.split(' ');
                const port = parts[0]; // COM1, COM2, etc.
                const baudrate = parseInt(parts[1].replace('dps', '')); // 115200dps -> 115200
                const dataBits = parseInt(parts[2]); // 8 data bits -> 8
                const stopBits = parseFloat(parts[4]); // 1 stop bit -> 1
                const parity = parts[6] === 'No' ? 'none' : parts[6].toLowerCase(); // No parity -> none

                return {
                    port,
                    baudrate,
                    dataBits,
                    stopBits,
                    parity
                };
            } catch (error) {
                console.error('解析串口信息失败:', error);
                return null;
            }
        }

        /**
         * 解析UDP连接信息
         * @param {string} connectionInfo - 连接信息字符串
         * @returns {Object|null} 解析后的连接参数
         */
        function parseUDPInfo(connectionInfo) {
            try {
                // 示例: "UDP, Local IP: 192.168.0.100:7010 UDP, Target IP: 192.168.0.101:7010"
                const localMatch = connectionInfo.match(/Local IP:\s*(\d+\.\d+\.\d+\.\d+):(\d+)/);
                const targetMatch = connectionInfo.match(/Target IP:\s*(\d+\.\d+\.\d+\.\d+):(\d+)/);

                if (!localMatch || !targetMatch) {
                    throw new Error('UDP信息格式不正确');
                }

                return {
                    localIP: localMatch[1],
                    localPort: parseInt(localMatch[2]),
                    targetIP: targetMatch[1],
                    targetPort: parseInt(targetMatch[2])
                };
            } catch (error) {
                console.error('解析UDP信息失败:', error);
                return null;
            }
        }

        // 页面关闭时清理所有连接
        window.addEventListener('beforeunload', function () {
            connectionInstances.forEach((connection, key) => {
                try {
                    connection.close();
                    console.log(`清理连接: ${key}`);
                } catch (error) {
                    console.error(`清理连接失败: ${error.message}`);
                }
            });
            connectionInstances.clear();
        });
    </script>
</body>

</html>